<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard — Farmacia Sistema</title>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"/>
  <!-- OverlayScrollbars -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/styles/overlayscrollbars.min.css"/>
  <!-- Bootstrap (solo si NO lo cargas en adminlte.css) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- AdminLTE v4 -->
  <link rel="stylesheet" href="css/adminlte.css"/>

 <!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="/favicons/index.svg?v=2">
<link rel="alternate icon" href="/favicons/index.svg?v=2">
<meta name="theme-color" content="#0ea5e9">

  <!-- Estilos extra del dashboard -->
  <style>
    :root{
      --dash-grad-1: linear-gradient(135deg, #0ea5e9 0%, #22c55e 100%);
      --dash-grad-2: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
      --dash-grad-3: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      --dash-grad-4: linear-gradient(135deg, #14b8a6 0%, #3b82f6 100%);
    }
    .card-kpi{
      border: 0;
      color: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
      overflow: hidden;
    }
    .card-kpi .icon-wrap{
      width: 56px; height: 56px;
      display: grid; place-items: center;
      background: rgba(255,255,255,.2);
      border-radius: 14px;
    }
    .card-kpi .kpi{
      font-weight: 700;
      letter-spacing: .2px;
    }
    .kpi-1{ background: var(--dash-grad-1); }
    .kpi-2{ background: var(--dash-grad-2); }
    .kpi-3{ background: var(--dash-grad-3); }
    .kpi-4{ background: var(--dash-grad-4); }

    .card{
      border: 0;
      box-shadow: 0 12px 30px rgba(2,6,23,.06);
      border-radius: 1rem;
    }
    .card-header{
      background: #fff;
      border-bottom: 1px solid rgba(2,6,23,.06);
      font-weight: 600;
    }
    canvas{
      filter: drop-shadow(0 12px 14px rgba(2,6,23,.08));
    }
    .toolbar .form-select{
  padding: 6px 2.25rem 6px 12px;   /* deja espacio para la flecha */
  background-position: right .6rem center; /* mueve la flecha a la derecha */
  background-size: 16px 12px;      /* tamaño estándar del caret de Bootstrap */
  line-height: 1.5;                 /* altura de línea agradable */
}
.toolbar .btn{
  height: auto;             /* ← sin altura fija */
  padding: 6px 12px;
  display: inline-flex;     /* ← mantiene icono + texto en una línea */
  align-items: center;
  gap: .4rem;
  white-space: nowrap;      /* ← no se parte en dos líneas */
}
    table.table tbody tr > *{
      vertical-align: middle;
    }
  </style>
</head>

<body class="layout-fixed sidebar-expand-lg sidebar-open bg-body-tertiary">
  <div class="app-wrapper">
    <!-- Header -->
    <nav class="app-header navbar navbar-expand bg-body">
      <div class="container-fluid">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-lte-toggle="sidebar" href="#" role="button">
              <i class="bi bi-list"></i>
            </a>
          </li>
        </ul>

        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown user-menu">
            <a href="#" class="nav-link dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown">
              <img src="./assets/img/alexanderpierce.jpg" class="user-image img-circle elevation-2" alt="User" width="30" height="30"/>
              <span id="navbar-username" class="d-none d-md-inline">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" style="min-width:240px">
              <li class="user-header bg-primary text-center text-white">
                <img src="./assets/img/alexanderpierce.jpg" class="img-circle elevation-2 mb-2" alt="User" width="80" height="80"/>
                <p class="mb-1"><strong id="user-fullname">Nombre Completo</strong></p>
                <small id="user-email">email@ejemplo.com</small><br/>
                <small id="user-address">Dirección</small>
              </li>
              <li class="user-footer d-flex justify-content-between px-2">
                <a href="perfil.html" class="btn btn-light btn-sm">Perfil</a>
                <a href="login.html" id="btn-logout" class="btn btn-outline-danger btn-sm">
                  <i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Sidebar -->
    <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
      <div class="sidebar-brand">
        <a href="index.html" class="brand-link d-flex align-items-center gap-2">
          <img src="assets/img/logofarmacia.png" alt="Logo" class="brand-image opacity-75 shadow"/>
          <span class="brand-text fw-light">FARMACIA SISTEMA</span>
        </a>
      </div>
      <div class="sidebar-wrapper">
        <nav class="mt-2">
          <ul class="nav sidebar-menu flex-column" role="navigation">
            <li id="menu-usuarios" class="nav-item">
              <a href="usuarios.html" class="nav-link"><i class="nav-icon bi bi-people-fill"></i><p>USUARIOS</p></a>
            </li>
            <li id="menu-clientes" class="nav-item">
              <a href="clientes.html" class="nav-link"><i class="nav-icon bi bi-person-lines-fill"></i><p>CLIENTES</p></a>
            </li>
            <li id="menu-productos" class="nav-item">
              <a href="productos.html" class="nav-link"><i class="nav-icon bi bi-box-seam"></i><p>PRODUCTOS</p></a>
            </li>
            <li id="menu-ventas" class="nav-item">
              <a href="ventas.html" class="nav-link"><i class="nav-icon bi bi-cash-stack"></i><p>VENTAS</p></a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>

    <!-- Main -->
    <main class="app-main">
      <!-- Título + toolbar -->
      <div class="app-content-header">
        <div class="container-fluid">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div>
              <h3 class="mb-0">Dashboard</h3>
              <small class="text-secondary">Resumen de actividad y ventas</small>
            </div>
            <div class="toolbar d-flex align-items-center gap-2">
              <label class="text-secondary">Rango</label>
              <select id="dash-range" class="form-select form-select-sm">
                <option value="7">7 días</option>
                <option value="30" selected>30 días</option>
                <option value="90">90 días</option>
                <option value="365">1 año</option>
              </select>
             <button id="btn-refresh"
        type="button"
        class="btn btn-outline-primary btn-sm d-inline-flex align-items-center gap-2 px-3">
  <i class="bi bi-arrow-clockwise"></i>
  <span>Actualizar</span>
</button>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="container-fluid px-3 px-md-4">
        <div class="row g-3">
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card card-kpi kpi-1">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="small opacity-75">Ingresos (últimos <span id="kpi-days-1">30</span>d)</div>
                  <div class="display-6 kpi">S/ <span id="kpi-ingresos">0.00</span></div>
                </div>
                <div class="icon-wrap"><i class="bi bi-cash-stack fs-3"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card card-kpi kpi-2">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="small opacity-75">Ventas</div>
                  <div class="display-6 kpi" id="kpi-ventas">0</div>
                </div>
                <div class="icon-wrap"><i class="bi bi-receipt fs-3"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card card-kpi kpi-3">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="small opacity-75">Clientes</div>
                  <div class="display-6 kpi" id="kpi-clientes">0</div>
                </div>
                <div class="icon-wrap"><i class="bi bi-people fs-3"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="card card-kpi kpi-4">
              <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                  <div class="small opacity-75">Items vendidos</div>
                  <div class="display-6 kpi" id="kpi-items">0</div>
                </div>
                <div class="icon-wrap"><i class="bi bi-bag-check fs-3"></i></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mt-1">
          <div class="col-lg-8">
            <div class="card h-100">
              <div class="card-header">Ingresos diarios</div>
              <div class="card-body">
                <canvas id="chart-ingresos" height="120"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card h-100">
              <div class="card-header">Top productos (unidades)</div>
              <div class="card-body">
                <canvas id="chart-topprod" height="120"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Tablas -->
        <div class="row g-3 mt-1">
          <div class="col-xl-6">
            <div class="card h-100">
              <div class="card-header">Top clientes (gasto)</div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Cliente</th>
                        <th class="text-end">Compras</th>
                        <th class="text-end">Gasto (S/)</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-top-clientes"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="col-xl-6">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span>Ingresos (tabla)</span>
                <button id="btn-exp-csv" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-download me-1"></i> Exportar CSV
                </button>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-sm table-striped mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>Fecha</th>
                        <th class="text-end">Ingresos (S/)</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-ingresos"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="app-footer mt-4">
          <div class="float-end d-none d-sm-inline">Anything you want</div>
          <strong>Copyright &copy; 2014-2025 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights reserved.
        </footer>
      </div>
    </main>
  </div>

  <!-- Scripts base -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/adminlte.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <!-- Guard de sesión -->
  <script>
  (function () {
    const raw = localStorage.getItem('session');
    if (!raw) return (location.href = 'login.html');
    let session;
    try { session = JSON.parse(raw); } catch { localStorage.removeItem('session'); return (location.href = 'login.html'); }
    if (!session.loggedIn) return (location.href = 'login.html');

    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? ''; };
    set('navbar-username', session.user?.username || 'Usuario');
    set('user-fullname',   session.user?.nombreCompleto || '');
    set('user-email',      session.user?.email || '');
    set('user-address',    session.user?.direccion || '');

    const logoutBtn = document.getElementById('btn-logout');
    if (logoutBtn) logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('session');
      location.href = 'login.html';
    });
  })();
  </script>

  <!-- Dashboard -->
  <script>
  (function(){
    const $ = (s) => document.querySelector(s);
    const fmtMoney = (n) => (Number(n||0)).toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2});

    // Plugin simple para “sombra” (efecto 3D)
    const shadowPlugin = {
      id: 'shadowPlugin',
      afterDatasetsDraw(chart) {
        const {ctx} = chart;
        ctx.save();
        ctx.shadowColor = 'rgba(0,0,0,.18)';
        ctx.shadowBlur = 14;
        ctx.shadowOffsetY = 8;
        const meta = chart.getDatasetMeta(0);
        if (meta?.dataset) meta.dataset.draw(ctx);
        ctx.restore();
      }
    };
    Chart.register(shadowPlugin);

    let chartIngresos = null;
    let chartTopProd  = null;

    function gradient(ctx, area, color1, color2){
      const g = ctx.createLinearGradient(0, area.top, 0, area.bottom);
      g.addColorStop(0, color1);
      g.addColorStop(1, color2);
      return g;
    }

    // >>> Rellena días sin ventas con 0 para el rango seleccionado
    function makeDailySeries(days, rows){
      const map = new Map((rows||[]).map(r => [String(r.fecha).slice(0,10), Number(r.ingresos||0)]));
      const labels = [];
      const values = [];
      const today = new Date();
      for (let i = days - 1; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(today.getDate() - i);
        const key = d.toISOString().slice(0,10);
        labels.push(key);
        values.push(map.get(key) ?? 0);
      }
      return {labels, values};
    }

    async function loadDashboard(days=30){
      $('#kpi-days-1').textContent = days;

      const r = await fetch('/api/dashboard?days=' + days);
      if(!r.ok){ console.error('dashboard error'); return; }
      const data = await r.json();

      // KPIs
      $('#kpi-ingresos').textContent = fmtMoney(data.kpis.ingresos);
      $('#kpi-ventas').textContent   = data.kpis.ventas;
      $('#kpi-clientes').textContent = data.kpis.clientes;
      $('#kpi-items').textContent    = data.kpis.items;

      // Serie completa (incluye días 0)
      const series = makeDailySeries(days, data.serieIngresos || []);

      // Tabla ingresos (usar serie completa)
      const tIng = $('#tbl-ingresos'); tIng.innerHTML = '';
      for(let i = series.labels.length-1; i>=0; i--){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${series.labels[i]}</td><td class="text-end">${fmtMoney(series.values[i])}</td>`;
        tIng.appendChild(tr);
      }

      // Top clientes
      const tCli = $('#tbl-top-clientes'); tCli.innerHTML = '';
      for(const c of (data.topClientes||[])){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.nombres}</td><td class="text-end">${c.compras}</td><td class="text-end">${fmtMoney(c.gasto)}</td>`;
        tCli.appendChild(tr);
      }

      // Chart ingresos
      const c1 = document.getElementById('chart-ingresos').getContext('2d');
      if(chartIngresos) chartIngresos.destroy();
      chartIngresos = new Chart(c1, {
        type: 'line',
        data: {
          labels: series.labels,
          datasets: [{
            label: 'Ingresos (S/)',
            data: series.values,
            fill: true,
            borderWidth: 2,
            pointRadius: 2,
            segment: { borderColor: '#0ea5e9' }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => 'S/ ' + fmtMoney(ctx.parsed.y) } }
          },
          scales: {
            y: { beginAtZero:true, ticks: { callback: v => 'S/ ' + fmtMoney(v) }, grid: { color: 'rgba(2,6,23,.06)' } },
            x: { grid: { display: false } }
          }
        },
        plugins: [{
          id:'bgFill',
          beforeDatasetsDraw(chart){
            const {ctx, chartArea} = chart;
            chart.data.datasets[0].backgroundColor = gradient(ctx, chartArea, 'rgba(14,165,233,.35)', 'rgba(14,165,233,0)');
          }
        }]
      });

      // Chart top productos
      const c2 = document.getElementById('chart-topprod').getContext('2d');
      const pLabels = (data.topProductos||[]).map(x => x.nombre);
      const pValues = (data.topProductos||[]).map(x => x.unidades);
      if(chartTopProd) chartTopProd.destroy();
      chartTopProd = new Chart(c2, {
        type: 'bar',
        data: {
          labels: pLabels,
          datasets: [{
            label: 'Unidades',
            data: pValues,
            borderWidth: 0,
            borderRadius: 10
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { display: false } },
            x: { beginAtZero:true, grid: { color: 'rgba(2,6,23,.06)' } }
          }
        },
        plugins: [{
          id:'barFill',
          beforeDatasetsDraw(chart){
            const {ctx, chartArea} = chart;
            chart.data.datasets[0].backgroundColor = gradient(ctx, chartArea, 'rgba(99,102,241,.9)', 'rgba(6,182,212,.75)');
          }
        }]
      });

      // Export CSV usando la serie completa
      document.getElementById('btn-exp-csv').onclick = () => {
        const rows = [['Fecha','Ingresos_Soles']];
        for(let i=0;i<series.labels.length;i++){
          rows.push([series.labels[i], series.values[i]]);
        }
        const csv  = rows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href = url; a.download = `ingresos_${days}d.csv`; a.click();
        URL.revokeObjectURL(url);
      };
    }

    const sel = document.getElementById('dash-range');
    const btn = document.getElementById('btn-refresh');
    sel.addEventListener('change', () => loadDashboard(Number(sel.value)));
    btn.addEventListener('click', () => loadDashboard(Number(sel.value)));
    loadDashboard(Number(sel.value || 30));
  })();
  </script>

  <!-- Reglas de accesos -->
  <script src="js/guard-accesos.js"></script>
</body>
</html>
